window.addEventListener("error",function(e){ga("send","exception",{exDescription:e.message,exFatal:!1})}),jQuery.error=function(e){ga("send","exception",{exDescription:e,exFatal:!1})},$(document).ajaxError(function(e,t,o){ga("send","exception",{exDescription:t.statusText,exFatal:!1})}),function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.download=t()}(this,function(){return function e(t,o,n){function i(e){var t=e.split(/[:;,]/),o=t[1],n="base64"==t[2]?atob:decodeURIComponent,i=n(t.pop()),r=i.length,a=0,s=new Uint8Array(r);for(a;r>a;++a)s[a]=i.charCodeAt(a);return new v([s],{type:o})}function r(e,t){if("download"in f)return f.href=e,f.setAttribute("download",L),f.className="download-js-link",f.innerHTML="downloading...",m.body.appendChild(f),setTimeout(function(){f.click(),m.body.removeChild(f),t===!0&&setTimeout(function(){d.URL.revokeObjectURL(f.href)},250)},66),!0;if("undefined"!=typeof safari)return e="data:"+e.replace(/^data:([\w\/\-\+]+)/,c),window.open(e)||confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")&&(location.href=e),!0;var o=m.createElement("iframe");m.body.appendChild(o),t||(e="data:"+e.replace(/^data:([\w\/\-\+]+)/,c)),o.src=e,setTimeout(function(){m.body.removeChild(o)},333)}var a,s,l,d=window,c="application/octet-stream",h=n||c,p=t,u=!o&&!n&&p,m=document,f=m.createElement("a"),g=function(e){return String(e)},v=d.Blob||d.MozBlob||d.WebKitBlob||g,L=o||"download";if(v=v.call?v.bind(d):Blob,"true"===String(this)&&(p=[p,h],h=p[0],p=p[1]),u&&u.length<2048&&(L=u.split("/").pop().split("?")[0],f.href=u,-1!==f.href.indexOf(u))){var l=new XMLHttpRequest;return l.open("GET",u,!0),l.responseType="blob",l.onload=function(t){e(t.target.response,L,c)},l.send(),l}if(/^data\:[\w+\-]+\/[\w+\-]+[,;]/.test(p))return navigator.msSaveBlob?navigator.msSaveBlob(i(p),L):r(p);if(a=p instanceof v?p:new v([p],{type:h}),navigator.msSaveBlob)return navigator.msSaveBlob(a,L);if(d.URL)r(d.URL.createObjectURL(a),!0);else{if("string"==typeof a||a.constructor===g)try{return r("data:"+h+";base64,"+d.btoa(a))}catch(x){return r("data:"+h+","+encodeURIComponent(a))}s=new FileReader,s.onload=function(e){r(this.result)},s.readAsDataURL(a)}return!0}}),L.Control.ExportDrawings=L.Control.extend({includes:L.Mixin.Events,options:{position:"topleft",layer:null},onAdd:function(e){var t=L.DomUtil.create("div","leaflet-draw-toolbar leaflet-bar");L.DomEvent.addListener(t,"click",L.DomEvent.stopPropagation).addListener(t,"click",L.DomEvent.preventDefault).addListener(t,"click",function(){var e,t=[],o=this._layer;$.each(o.getLayers(),function(o,n){e=n.toGeoJSON(),e.properties.name=n.options.title,t.push(e)});var n={type:"FeatureCollection",features:t};console.log(JSON.stringify(n))});var o=L.DomUtil.create("a","leaflet-draw-edit-edit",t);return o.title="Export drawings",o.href="#",t._layer=this.options.layer,t}}),L.Control.ExportImage=L.Control.extend({includes:L.Mixin.Events,options:{position:"topleft"},initialize:function(e){e=e||{},L.Util.setOptions(this,e),L.Control.prototype.initialize.call(this,this.options)},onAdd:function(e){this._map=e;var t=this._container=L.DomUtil.create("div","leaflet-bar leaflet-control");L.DomEvent.disableClickPropagation(t).disableScrollPropagation(t);var o=L.DomEvent.stopPropagation;L.DomEvent.on(this._container,"mousedown",o).on(this._container,"touchstart",o).on(this._container,"dblclick",o).on(this._container,"mousewheel",o).on(this._container,"MozMozMousePixelScroll",o),L.DomEvent.on(t,"click",this._onExportClick,this);var n=L.DomUtil.create("a","",t);return n.title="Export Image",n.style.backgroundImage="url('/images/Camera.png')",t},_onExportClick:function(e){var t=this._map;this._container;this.fire("start");var o=this;leafletImage(t,function(e,t){var n=t.toDataURL("image/jpeg",.8);download(n,"export.jpg","image/jpeg"),o.fire("end")})}}),L.control.exportImage=function(e){return new L.Control.ExportImage(e)};var FantasyMap={options:{editor:!1,map:{minZoom:0,maxZoom:5},image:{width:4763,height:3185,TilesUrl:'@Url.Content("~/images/maps/FaerunTiles")',meterPerPixel:1287.473,attribution:""},data:{'@Url.Content("~/data/Faerun/Ports.json")':"Ports",'@Url.Content("~/data/Faerun/Cities.json")':"Cities",'@Url.Content("~/data/Faerun/PortCapitals.json")':"Port/Capitals",'@Url.Content("~/data/Faerun/Capitals.json")':"Capitals",'@Url.Content("~/data/Faerun/Temples.json")':"Temples",'@Url.Content("~/data/Faerun/Sites.json")':"Sites",'@Url.Content("~/data/Faerun/Fortresses.json")':"Fortresses",'@Url.Content("~/data/Faerun/Ruins.json")':"Ruins"},wiki:{url:"http://en.wikipedia.org",apiUrl:"http://forgottenrealms.wikia.com",attribution:"",wikiParseMarkup:function(e){var t=$("<div></div>").html(e);t.find("a").each(function(){$(this).replaceWith($(this).html())});var o=new RegExp("^(?:[a-z]+:)?//","i");return t.find("img").not('[src^="http"],[src^="https"]').each(function(){$(this).attr("src",function(e,t){return o.test(t)?void 0:FantasyMap.options.wiki.url+t})}),t.find("sup").remove(),t.find(".mw-ext-cite-error").remove(),t.find(".mw-editsection").remove(),t}}},initialize:function(e){window.jQuery.extend(FantasyMap.options,e);var t=this._map=L.map("map",{minZoom:this.options.map.minZoom,maxZoom:this.options.map.maxZoom,zoomControl:!1}),o=this._rc=new L.RasterCoords(t,[this.options.image.width,this.options.image.height]);o.setMaxBounds();var n=o.getBounds();t.fitBounds(n),L.tileLayer(this.options.image.TilesUrl+"/{z}/{x}/{y}.png",{noWrap:!0,bounds:n}).addTo(t);var i=L.control.layers(null,null,{position:"bottomright"}).addTo(t);new L.Control.Zoom({position:"bottomright"}).addTo(t);FantasyMap.overrideDistanceTo(this.options.image.meterPerPixel);var r=L.layerGroup().addTo(t),a=(this._searchControl=L.control.search({layer:r,initial:!1,position:"topleft",zoom:5,propertyName:"name",textPlaceholder:"Search LoreMaps",collapsed:!1}).addTo(t),this._sidebarControl=L.control.sidebar("sidebar",{closeButton:!0,position:"left",autoPan:!1}).addTo(t)),s=t.attributionControl;s.setPrefix('<a href="/">LoreMaps</a>'),s.addAttribution(this.options.image.attribution),s.addAttribution(this.options.wiki.attribution);var l={coordsToLatLng:function(e){return o.unproject(e)},pointToLayer:function(e,t){return L.marker(t,{opacity:.7,title:e.properties.name})},onEachFeature:function(e,t){t.on({click:function(t){ga("send",{hitType:"event",eventCategory:"Marker",eventAction:t.type,eventLabel:e.properties.name}),FantasyMap.openWikiLink(e.properties.name)}})}},d=new L.FeatureGroup;t.addLayer(d),$.each(this.options.data,function(e,t){$.getJSON(e).done(function(e){var o=L.geoJson(e,l);r.addLayer(o),i.addOverlay(o,t)})});var c={draw:{polygon:!1,circle:!1,rectangle:!1,marker:!1,polyline:{metric:window.LoreMaps.UserPreferences.UseMetric}},edit:{featureGroup:d,edit:!1,remove:!1}};this.options.editor?c={draw:{polygon:{allowIntersection:!1,showArea:!0},polyline:{metric:window.LoreMaps.UserPreferences.UseMetric}},edit:{featureGroup:d}}:(L.drawLocal.draw.toolbar.buttons.polyline="Measure distance",L.drawLocal.draw.handlers.polyline.tooltip.start="Click to start measurement.",L.drawLocal.draw.handlers.polyline.tooltip.cont="Click to continue measurement.",L.drawLocal.draw.handlers.polyline.tooltip.end="Click last point to finish measurement.");var h=new L.Control.Draw(c);if(t.addControl(h),this.options.editor){t.on("draw:created",function(e){var t=(e.layerType,e.layer),o=prompt("Please enter a name");t.bindPopup(o),t.options.title=o,d.addLayer(t)});new L.Control.ExportDrawings({layer:d}).addTo(t)}var p=(this._hexGridControl=L.control.hexGrid({mPerPixel:this.options.image.meterPerPixel,minX:0,minY:0,maxX:this.options.image.width,maxY:this.options.image.height,rc:o}).addTo(t),this._exportImageControl=L.control.exportImage().addTo(t));p.on("start",function(e){a.setContent("<h3>Creating image please wait...</h3>"),a.show()}),p.on("end",function(e){a.hide()});this._bookmarkControl=new L.Control.Bookmarks({position:"topleft"}).addTo(t);this.initializeGoogleAnalyticsHandlers()},overrideDistanceTo:function(e){var t=this._rc;L.LatLng.prototype.distanceTo=function(o){var n=t.project(this),i=t.project(o),r=i.x-n.x,a=i.y-n.y;return Math.sqrt(r*r+a*a)*e}},openWikiLink:function(e){var t=this._sidebarControl;t.setContent("Loading..."),t.show();this.options.wiki.apiUrl;$.ajax({dataType:"jsonp",cache:!0,url:this.options.wiki.apiUrl,data:{page:e,prop:"text",redirects:!0,action:"parse",format:"json"}}).done(function(o){if(o.parse&&o.parse.text){try{var n=o.parse.text["*"],i=FantasyMap.options.wiki.wikiParseMarkup(n),r=$("<h2>",{text:e}),a=i.prepend(r).html();t.setContent(a)}catch(s){throw ga("send","exception",{exDescription:s.message,exFatal:!0}),s}ga("send",{hitType:"pageview",page:document.location.pathname+"#"+encodeURIComponent(e),title:e})}else t.setContent("No references found for "+e),ga("send",{hitType:"pageview",page:document.location.pathname+"#404",title:e})}).fail(function(e,o,n){t.setContent("An error occurred while processing the request."),ga("send","exception",{exDescription:n.toString(),exFatal:!0})})},initializeGoogleAnalyticsHandlers:function(){var e=this._map,t=this._sidebarControl,o=this._searchControl,n=this._hexGridControl,i=this._exportImageControl;e.on("overlayadd overlayremove",function(e){ga("send",{hitType:"event",eventCategory:"Map",eventAction:e.type,eventLabel:e.name})}),t.on("shown hidden",function(e){ga("send",{hitType:"event",eventCategory:"Sidebar",eventAction:e.type})}),e.on("bookmark:removed bookmark:show bookmark:add",function(e){ga("send",{hitType:"event",eventCategory:"Bookmark",eventAction:e.type,eventLabel:e.data.name})}),e.on("popupopen popupclose",function(e){ga("send",{hitType:"event",eventCategory:"Bookmark",eventAction:e.type})}),o.on("search_expanded search_collapsed",function(e){ga("send",{hitType:"event",eventCategory:"Search",eventAction:e.type})}),o.on("search_locationfound",function(e){ga("send",{hitType:"event",eventCategory:"Search",eventAction:e.type,eventLabel:e.text})}),e.on("draw:created draw:drawstart draw:drawstop",function(e){ga("send",{hitType:"event",eventCategory:"Draw",eventAction:e.type,eventLabel:e.layerType})}),n.on("show hide",function(e){ga("send",{hitType:"event",eventCategory:"HexGrid",eventAction:e.type})}),n.on("hexResized",function(e){ga("send",{hitType:"event",eventCategory:"HexGrid",eventAction:e.type,eventValue:e.newSize})}),i.on("start end",function(e){ga("send",{hitType:"event",eventCategory:"ImageExport",eventAction:e.type})})}};L.Control.HexGrid=L.Control.extend({includes:L.Mixin.Events,options:{position:"topleft",mPerPixel:1,rc:null,minX:0,minY:0,maxX:5e3,maxY:3e3,hexWidth:60},initialize:function(e){e=e||{},L.Util.setOptions(this,e),L.Control.prototype.initialize.call(this,this.options);for(var t=this._cosines=[],o=this._sines=[],n=0;6>n;n++){var i=2*Math.PI/6*n;t.push(Math.cos(i)),o.push(Math.sin(i))}},onAdd:function(e){this._map=e,this._hexLayer=L.geoJson(),this._hexLayer.addTo(e);var t=this._container=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-hexgrid"),o=L.DomEvent.stopPropagation;L.DomEvent.on(this._container,"mousedown",o).on(this._container,"touchstart",o).on(this._container,"dblclick",o).on(this._container,"mousewheel",o).on(this._container,"MozMozMousePixelScroll",o);var n=this._toggleLink=L.DomUtil.create("a","hexGridLink",t);n.title="Show/hide HexGrid",L.DomEvent.on(this._toggleLink,"click",this.toggle,this);var i=L.DomUtil.create("div","hexGridRangeDiv",t),r=L.DomUtil.create("span","",i);r.innerText="1 hex = ";var a=this._rangeOutput=L.DomUtil.create("output","hexGridRangeOutput",i);a.innerText=this.options.hexWidth;var s=L.DomUtil.create("span","",i);s.innerText=window.LoreMaps.UserPreferences.UseMetric?" kilometers":" miles";var l=this._rangeInput=L.DomUtil.create("input","hexGridRangeInput",i);return l.type="range",l.value=this.options.hexWidth,l.min=60,l.max=320,l.step=5,L.DomEvent.on(this._rangeInput,"input",this.onRangeInput,this).on(this._rangeInput,"change",this.onRangeChange,this),L.DomEvent.on(e,"zoomend",this.onZoomEnd,this).on(e,"dragend",this.onDragEnd,this),t},isVisible:function(){return L.DomUtil.hasClass(this._toggleLink,"hexgrid-visible")},show:function(){this.isVisible()||(L.DomUtil.addClass(this._toggleLink,"hexgrid-visible"),this._createxGrid(),this.fire("show"))},hide:function(e){this.isVisible()&&(L.DomUtil.removeClass(this._toggleLink,"hexgrid-visible"),this._clearHexGrid(),this.fire("hide")),e&&L.DomEvent.stopPropagation(e)},toggle:function(){this.isVisible()?this.hide():this.show()},onRangeChange:function(){var e=this._rangeInput;this.options.hexWidth=e.value,this.fire("hexResized",{newSize:e.value}),this._clearHexGrid(),this._createxGrid()},onRangeInput:function(){var e=this._rangeInput,t=this._rangeOutput;t.value=e.value},onDragEnd:function(e){var t=this;this.isVisible()&&$(this._map).one("moveend",function(){t._clearHexGrid(),t._createxGrid()})},onZoomEnd:function(e){this.isVisible()&&(this._clearHexGrid(),this._createxGrid())},_clearHexGrid:function(){var e=this._map,t=this._hexLayer;e.removeLayer(t)},_createxGrid:function(){var e=this._map,t=this.options.rc,o=t.project(e.getBounds().getNorthWest()),n=t.project(e.getBounds().getSouthEast()),i=Math.max(o.x,this.options.minX),r=Math.max(o.y,this.options.minY),a=Math.min(n.x,this.options.maxX),s=Math.min(n.y,this.options.maxY),l=[i,r,a,s],d=this.options.hexWidth,c=window.LoreMaps.UserPreferences.UseMetric?"kilometers":"miles",h=this.turfHexGrid(l,d,c);this._hexLayer=L.geoJson(h,{coordsToLatLng:function(e){return t.unproject(e)},style:function(e){return{fill:!1,color:"#000",weight:1,clickable:!1}}}),e.hasLayer(this._hexLayer)||e.addLayer(this._hexLayer)},turfHexGrid:function(e,t,o){var n=turf.point,i=(this.distance,t/this.distance(n([e[0],e[1]]),n([e[2],e[1]]),o)),r=i*(e[2]-e[0]),a=t/this.distance(n([e[0],e[1]]),n([e[0],e[3]]),o),s=(a*(e[3]-e[1]),r/2),l=2*s,d=Math.sqrt(3)/2*l,c=e[2]-e[0],h=e[3]-e[1],p=.75*l,u=d,m=c/(l-s/2),f=Math.ceil(m);Math.round(m)===f&&f++;var g=(f*p-s/2-c)/2-s/2,v=Math.ceil(h/d),L=(h-v*d)/2,x=v*d-h>d/2;x&&(L-=d/4);for(var y=turf.featurecollection([]),w=0;f>w;w++)for(var C=0;v>=C;C++){var b=w%2===1;if(!(0===C&&b||0===C&&x)){var _=w*p+e[0]-g,k=C*u+e[1]+L;b&&(k-=d/2),y.features.push(this.hexagon([_,k],s))}}return y},hexagon:function(e,t){for(var o=this._cosines,n=this._sines,i=[],r=0;6>r;r++){var a=e[0]+t*o[r],s=e[1]+t*n[r];i.push([a,s])}return i.push(i[0]),turf.polygon([i])},distance:function(e,t,o){var n=this.options.mPerPixel;this.featureOf(e,"Point","distance"),this.featureOf(t,"Point","distance");var i,r=e.geometry.coordinates,a=t.geometry.coordinates,s=a[0]-r[0],l=a[1]-r[1],d=Math.sqrt(s*s+l*l);switch(o){case"miles":i=d*n*621371e-9;break;case"kilometers":i=d*n*.001;break;case void 0:i=d;break;default:throw new Error('unknown option given to "units"')}return i},featureOf:function(e,t,o){if(!o)throw new Error(".featureOf() requires a name");if(!e||"Feature"!==e.type||!e.geometry)throw new Error("Invalid input to "+o+", Feature with geometry required");if(!e.geometry||e.geometry.type!==t)throw new Error("Invalid input to "+o+": must be a "+t+", given "+e.geometry.type)}}),L.control.hexGrid=function(e){return new L.Control.HexGrid(e)},L.RasterCoords=function(e,t,o){this.map=e,this.width=t[0],this.height=t[1],this.tilesize=o||256,this.zoom=this.zoomLevel()},L.RasterCoords.prototype={zoomLevel:function(){return Math.ceil(Math.log(Math.max(this.width,this.height)/this.tilesize)/Math.log(2))},unproject:function(e){return this.map.unproject(e,this.zoom)},project:function(e){return this.map.project(e,this.zoom)},setMaxBounds:function(){var e=this.getBounds();this.map.setMaxBounds(e)},getBounds:function(){var e=this.unproject([0,this.height]),t=this.unproject([this.width,0]);return new L.LatLngBounds(e,t)}},function(e,t){var o={};if(e.LoreMaps||(e.LoreMaps=o),o.UserPreferences={UseMetric:!1,load:function(){this.UseMetric=JSON.parse(localStorage.getItem("UseMetricLM")||!1)},save:function(){localStorage.setItem("UseMetricLM",this.UseMetric)}},"undefined"==typeof Storage)throw"Web Storage is not supported";o.UserPreferences.load()}(window,document);